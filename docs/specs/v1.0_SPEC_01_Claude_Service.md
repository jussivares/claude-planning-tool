# SPEC_01: ClaudeService

> **Versio:** 1.0  
> **Päivitetty:** 2025-11-25  
> **Tiedosto:** v1.0_SPEC_01_Claude_Service.md  
> **Projekti:** Claude API -suunnittelutyökalu  
> **Tyyppi:** Toiminnallinen määrittely (SPEC)

---

## Yleiskatsaus

### Tarkoitus

ClaudeService on **platform layer wrapper** joka käärii kaikki Claude API -kutsut. Muu sovellus ei koskaan kutsu Claude API:a suoraan - kaikki kulkee ClaudeServicen kautta.

### Black Box -periaate

```
┌─────────────────────────────────────────────────────────────────┐
│                     SOVELLUS                                    │
│  (Chat UI, ContextManager, MemoryService)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    ClaudeService                                │
│                    ┌───────────┐                                │
│   send_message() ──►│           │──► Claude API                 │
│   stream_message()─►│  WRAPPER  │◄── Response                   │
│   count_tokens() ──►│           │                               │
│                    └───────────┘                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Miksi wrapper?

| Hyöty | Selitys |
|-------|---------|
| **Vaihdettavuus** | Voi vaihtaa toiseen AI-palveluun muuttamatta sovellusta |
| **Testattavuus** | Helppo mockata testeissä |
| **Virheenkäsittely** | Keskitetty paikka käsitellä API-virheet |
| **Konfigurointi** | Yksi paikka hallita malleja, parametreja, headereita |
| **Monitorointi** | Keskitetty lokitus ja kustannusseuranta |

---

## Primitiivi

### Message

ClaudeServicen primitiivi on **Message** - yksittäinen viesti keskustelussa.

```python
@dataclass
class Message:
    role: Literal["user", "assistant"]
    content: str | list[ContentBlock]
    timestamp: datetime
    token_count: int | None = None
    model: str | None = None
    
@dataclass
class ContentBlock:
    type: Literal["text", "image", "tool_use", "tool_result"]
    # type-specific fields...
```

### Miksi Message?

- Kaikki API-operaatiot käsittelevät Message-objekteja
- Yleistettävissä multimodal-sisältöön (kuvat, dokumentit)
- Yhteensopiva keskusteluhistorian kanssa

---

## Julkinen API

### Ydinmetodit

```python
class ClaudeService:
    """
    Platform layer wrapper Claude API:lle.
    
    Kaikki Claude API -kutsut kulkevat tämän kautta.
    Muu sovellus ei koskaan kutsu Anthropic SDK:ta suoraan.
    """
    
    async def send_message(
        self,
        messages: list[Message],
        *,
        system_prompt: str | None = None,
        model: ModelName | None = None,
        max_tokens: int | None = None,
        temperature: float | None = None,
    ) -> Message:
        """
        Lähetä viesti ja odota täydellinen vastaus.
        
        Args:
            messages: Keskusteluhistoria
            system_prompt: Järjestelmäprompt (valinnainen)
            model: Mallin nimi (oletuksena config.default_model)
            max_tokens: Max vastaus-tokenit (oletuksena config.default_max_tokens)
            temperature: Lämpötila 0.0-1.0 (oletuksena config.default_temperature)
            
        Returns:
            Message: Claudelta saatu vastaus
            
        Raises:
            ClaudeAPIError: API-kutsu epäonnistui
            RateLimitError: Rate limit ylitetty
            TokenLimitError: Konteksti-ikkuna täynnä
        """
        ...
    
    async def stream_message(
        self,
        messages: list[Message],
        *,
        system_prompt: str | None = None,
        model: ModelName | None = None,
        max_tokens: int | None = None,
        temperature: float | None = None,
    ) -> AsyncIterator[StreamEvent]:
        """
        Lähetä viesti ja vastaanota vastaus streamina.
        
        Yields:
            StreamEvent: Teksti-deltat ja metadata
            
        Example:
            async for event in service.stream_message(messages):
                if event.type == "text_delta":
                    print(event.text, end="")
                elif event.type == "message_complete":
                    print(f"\nTokens: {event.usage.total_tokens}")
        """
        ...
    
    def count_tokens(
        self,
        messages: list[Message],
        *,
        system_prompt: str | None = None,
    ) -> TokenCount:
        """
        Laske tokenien määrä viesteistä.
        
        Returns:
            TokenCount: input_tokens, estimated_output, total
        """
        ...
```

### Konfigurointi

```python
class ClaudeConfig:
    """
    ClaudeServicen konfiguraatio.
    
    Ladataan ympäristömuuttujista ja/tai config-tiedostosta.
    """
    
    # API-yhteys
    api_key: str                          # ANTHROPIC_API_KEY
    api_version: str = "2023-06-01"       # anthropic-version header
    
    # Oletusmalli
    default_model: ModelName = "sonnet-4.5"
    default_max_tokens: int = 8192
    default_temperature: float = 0.7
    
    # 1M konteksti (beta)
    enable_1m_context: bool = True
    beta_headers: list[str] = ["context-1m-2025-08-07"]
    
    # Retry-strategia
    max_retries: int = 3
    retry_delay: float = 1.0              # Exponential backoff base
    
    # Kustannusseuranta
    track_costs: bool = True
    cost_warning_threshold: float = 10.0  # $ per sessio
```

### Mallit

```python
class ModelName(str, Enum):
    """Tuetut mallit."""
    
    OPUS_4_5 = "opus-4.5"
    SONNET_4_5 = "sonnet-4.5"
    SONNET_4 = "sonnet-4"
    HAIKU_4_5 = "haiku-4.5"
    
    @property
    def api_id(self) -> str:
        """Palauttaa API:n odottaman mallin ID:n."""
        return {
            "opus-4.5": "claude-opus-4-5-20251101",
            "sonnet-4.5": "claude-sonnet-4-5-20250929",
            "sonnet-4": "claude-sonnet-4-20250514",
            "haiku-4.5": "claude-haiku-4-5-20251001",
        }[self.value]
    
    @property
    def supports_1m_context(self) -> bool:
        """Tukeeko malli 1M kontekstia."""
        return self in [ModelName.SONNET_4_5, ModelName.SONNET_4]
    
    @property
    def input_price_per_million(self) -> float:
        """Hinta per miljoona input-tokenia."""
        return {
            "opus-4.5": 5.0,
            "sonnet-4.5": 3.0,
            "sonnet-4": 3.0,
            "haiku-4.5": 1.0,
        }[self.value]
    
    @property
    def output_price_per_million(self) -> float:
        """Hinta per miljoona output-tokenia."""
        return {
            "opus-4.5": 25.0,
            "sonnet-4.5": 15.0,
            "sonnet-4": 15.0,
            "haiku-4.5": 5.0,
        }[self.value]
```

---

## Tietotyypit

### StreamEvent

```python
@dataclass
class StreamEvent:
    """Streaming-vastauksen event."""
    
    type: Literal[
        "message_start",
        "text_delta", 
        "tool_use",
        "message_complete",
        "error"
    ]
    
    # text_delta
    text: str | None = None
    
    # message_complete
    message: Message | None = None
    usage: TokenUsage | None = None
    
    # error
    error: ClaudeAPIError | None = None
```

### TokenUsage

```python
@dataclass
class TokenUsage:
    """Token-käyttötilasto."""
    
    input_tokens: int
    output_tokens: int
    cache_creation_tokens: int = 0
    cache_read_tokens: int = 0
    
    @property
    def total_tokens(self) -> int:
        return self.input_tokens + self.output_tokens
    
    def calculate_cost(self, model: ModelName, premium_rate: bool = False) -> float:
        """Laske kustannus dollareissa."""
        input_price = model.input_price_per_million
        output_price = model.output_price_per_million
        
        if premium_rate:  # >200K tokenia
            input_price *= 2
            output_price *= 1.5
        
        input_cost = (self.input_tokens / 1_000_000) * input_price
        output_cost = (self.output_tokens / 1_000_000) * output_price
        
        return input_cost + output_cost
```

### TokenCount

```python
@dataclass
class TokenCount:
    """Token-laskennan tulos."""
    
    input_tokens: int
    estimated_output: int  # Arvio max_tokens perusteella
    
    @property
    def total(self) -> int:
        return self.input_tokens + self.estimated_output
    
    @property
    def context_usage_percent(self) -> float:
        """Kuinka suuri osa 1M kontekstista käytössä."""
        return (self.input_tokens / 1_000_000) * 100
```

---

## Virheenkäsittely

### Virhetyypit

```python
class ClaudeAPIError(Exception):
    """Perusvirhe kaikille API-virheille."""
    
    status_code: int
    error_type: str
    message: str
    
class RateLimitError(ClaudeAPIError):
    """Rate limit ylitetty."""
    
    retry_after: float  # Sekuntia ennen uutta yritystä

class TokenLimitError(ClaudeAPIError):
    """Konteksti-ikkuna täynnä."""
    
    current_tokens: int
    max_tokens: int

class AuthenticationError(ClaudeAPIError):
    """API-avain virheellinen tai puuttuu."""

class ModelNotAvailableError(ClaudeAPIError):
    """Pyydetty malli ei saatavilla."""
```

### Retry-strategia

```python
# Sisäinen toteutus (ei osa julkista API:a)

async def _call_with_retry(self, func, max_retries: int = 3):
    """
    Exponential backoff retry.
    
    Retry näissä tilanteissa:
    - 429 Rate Limited
    - 500+ Server errors
    - 529 Overloaded
    
    EI retry:
    - 400 Bad Request
    - 401 Unauthorized
    - 413 Payload Too Large
    """
    for attempt in range(max_retries):
        try:
            return await func()
        except RateLimitError as e:
            if attempt == max_retries - 1:
                raise
            wait = e.retry_after or (2 ** attempt)
            await asyncio.sleep(wait)
        except ClaudeAPIError as e:
            if e.status_code >= 500:
                if attempt == max_retries - 1:
                    raise
                await asyncio.sleep(2 ** attempt)
            else:
                raise
```

---

## Käyttöesimerkit

### Perusviesti

```python
from claude_service import ClaudeService, Message

service = ClaudeService()

# Yksinkertainen kysymys
messages = [
    Message(role="user", content="Mikä on Python?")
]

response = await service.send_message(messages)
print(response.content)
```

### Streaming

```python
# Streaming-vastaus
messages = [
    Message(role="user", content="Kirjoita lyhyt tarina.")
]

async for event in service.stream_message(messages):
    if event.type == "text_delta":
        print(event.text, end="", flush=True)
    elif event.type == "message_complete":
        print(f"\n\nTokens: {event.usage.total_tokens}")
        print(f"Cost: ${event.usage.calculate_cost(ModelName.SONNET_4_5):.4f}")
```

### Mallin valinta

```python
# Vaativa tehtävä → Opus
response = await service.send_message(
    messages,
    model=ModelName.OPUS_4_5,
    max_tokens=16000,
)

# Nopea tehtävä → Haiku
response = await service.send_message(
    messages,
    model=ModelName.HAIKU_4_5,
    max_tokens=1024,
)
```

### Token-laskenta ennen lähetystä

```python
# Tarkista mahtuuko kontekstiin
token_count = service.count_tokens(messages, system_prompt=system_prompt)

if token_count.input_tokens > 200_000:
    print(f"Varoitus: {token_count.input_tokens} tokenia")
    print(f"Premium-hinnoittelu aktivoituu (2x input, 1.5x output)")

if token_count.input_tokens > 900_000:
    print("Virhe: Liian lähellä 1M rajaa, tiivistä kontekstia")
```

### Virheenkäsittely

```python
try:
    response = await service.send_message(messages)
except RateLimitError as e:
    print(f"Rate limit, odota {e.retry_after}s")
except TokenLimitError as e:
    print(f"Konteksti täynnä: {e.current_tokens}/{e.max_tokens}")
except ClaudeAPIError as e:
    print(f"API-virhe: {e.error_type} - {e.message}")
```

---

## Sisäinen toteutus (yleiskuva)

> **Huom:** Tämä osio kuvaa toteutuksen yleisperiaatteet, ei tarkkaa koodia. TECH_SPEC sisältää tarkan toteutuksen.

### Arkkitehtuuri

```
┌─────────────────────────────────────────────────────────────────┐
│                    ClaudeService                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   Config    │    │   Client    │    │   Metrics   │         │
│  │   Loader    │    │   (SDK)     │    │   Tracker   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                  │                  │                 │
│         ▼                  ▼                  ▼                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Request Handler                        │   │
│  │  - Validoi parametrit                                   │   │
│  │  - Rakenna API-pyyntö                                   │   │
│  │  - Käsittele vastaus                                    │   │
│  │  - Retry-logiikka                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Anthropic     │
                    │   Python SDK    │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Claude API    │
                    │   (external)    │
                    └─────────────────┘
```

### Vastuut

| Komponentti | Vastuu |
|-------------|--------|
| **Config Loader** | Lataa asetukset env/tiedostosta |
| **Client (SDK)** | Anthropic SDK:n instanssi |
| **Metrics Tracker** | Token-käyttö, kustannukset, latenssi |
| **Request Handler** | Pyyntöjen rakentaminen ja vastausten käsittely |

---

## Riippuvuudet

### Ulkoiset (wrappattavat)

| Riippuvuus | Käyttö | Wrappaus |
|------------|--------|----------|
| `anthropic` | Anthropic Python SDK | ClaudeService wrappaa kokonaan |

### Sisäiset (käyttää)

| Moduuli | Käyttö |
|---------|--------|
| - | ClaudeService ei riipu muista moduuleista |

### Sisäiset (käytetään)

| Moduuli | Käyttää ClaudeServicea |
|---------|------------------------|
| ContextManager | Lähettää viestit Claudelle |
| Chat UI | Käyttöliittymän kautta |

---

## Rajaukset (MVP)

### Sisältyy MVP:hen

- ✅ send_message (täysi vastaus)
- ✅ stream_message (streaming)
- ✅ count_tokens (arvio)
- ✅ Mallin valinta (4 mallia)
- ✅ 1M konteksti (Sonnet)
- ✅ Retry-logiikka
- ✅ Kustannuslaskenta
- ✅ Virheenkäsittely

### EI sisälly MVP:hen (myöhemmin)

- ❌ Tool use / function calling
- ❌ Multimodal (kuvat, PDF)
- ❌ Batch API
- ❌ Prompt caching
- ❌ Opus effort-parametri
- ❌ Computer use

---

## Testausstrategia

### Yksikkötestit

```python
# Mock Anthropic SDK
@pytest.fixture
def mock_anthropic():
    with patch("anthropic.Anthropic") as mock:
        yield mock

async def test_send_message_success(mock_anthropic):
    """Perusviesti onnistuu."""
    mock_anthropic.return_value.messages.create.return_value = MockResponse(
        content=[{"type": "text", "text": "Vastaus"}],
        usage={"input_tokens": 10, "output_tokens": 20}
    )
    
    service = ClaudeService()
    response = await service.send_message([
        Message(role="user", content="Hei")
    ])
    
    assert response.content == "Vastaus"
    assert response.token_count == 20
```

### Integraatiotestit

```python
@pytest.mark.integration
async def test_real_api_call():
    """Oikea API-kutsu (vaatii API-avaimen)."""
    service = ClaudeService()
    
    response = await service.send_message([
        Message(role="user", content="Sano 'testi'")
    ])
    
    assert "testi" in response.content.lower()
```

---

## Hyväksymiskriteerit

### Toiminnalliset

- [ ] Viesti lähetys ja vastaanotto toimii
- [ ] Streaming toimii
- [ ] Kaikki 4 mallia toimivat
- [ ] 1M konteksti aktivoituu Sonnetilla
- [ ] Retry toimii rate limitissä
- [ ] Virheet käsitellään oikein

### Ei-toiminnalliset

- [ ] Vastausaika <2s (stream start)
- [ ] Kustannuslaskenta ±5% tarkkuudella
- [ ] 100% testikattavuus julkiselle API:lle

---

## Muutoshistoria

| Versio | Päivämäärä | Muutokset |
|--------|------------|-----------|
| 1.0 | 2025-11-25 | Ensimmäinen versio |

---

## Seuraavat askeleet

1. **TECH_SPEC_01** - Tarkennettu tekninen suunnitelma
2. **Toteutus** - ClaudeService Python-koodi
3. **Testit** - Yksikkö- ja integraatiotestit

---

*Tämä dokumentti määrittelee ClaudeServicen toiminnalliset vaatimukset. Tekninen toteutus dokumentoidaan TECH_SPEC_01:ssä.*
